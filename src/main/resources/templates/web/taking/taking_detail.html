<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/user_layout}">
    <div layout:fragment="content">
        <!-- ë‹¬ë ¥ ê¸°ëŠ¥ì„ ìœ„í•œ ë§í¬ ë° ìŠ¤íƒ€ì¼ ì ìš© ì‹œì‘ -->
        <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #eaeff1;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
            }
            #calendar {
                max-width: 900px;
                margin: 40px auto;
                padding: 0 10px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            .card {
                background-color: #ffffff;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                border: 1px solid #e0e0e0; /* ì—°í•œ íšŒìƒ‰ í…Œë‘ë¦¬ */
            }

            .card-header {
                background-color: #9fcb3d; /* ì´ˆë¡ìƒ‰ ë°°ê²½ */
                color: #ffffff;
                padding: 15px;
                text-align: center;
                font-size: 1.5rem; /* ë” í° í°íŠ¸ ì‚¬ì´ì¦ˆ */
                font-weight: bold;
            }

            .card-content {
                padding: 20px;
            }

            .pillContainer {
                padding: 20px;
                background-color: #f9f9f9; /* ë§¤ìš° ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
                border-top: 1px solid #e0e0e0; /* ì—°í•œ íšŒìƒ‰ ìƒë‹¨ í…Œë‘ë¦¬ */
                border-radius: 0 0 8px 8px;
            }

            .btn {
                display: inline-block;
                background-color: #9fcb3d; /* ì´ˆë¡ìƒ‰ ë°°ê²½ */
                color: #ffffff;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                text-align: center;
                text-decoration: none;
                font-weight: bold;
                margin-top: 10px;
                cursor: pointer;
                transition: background-color 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ í˜¸ë²„ íš¨ê³¼ */
            }

            .btn:hover {
                background-color: #1e4d35; /* ë²„íŠ¼ í˜¸ë²„ ì‹œ ì–´ë‘ìš´ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€í™” */
            }

            .pillContainer::before {
                content: '';
                display: block;
                width: 50px;
                height: 5px;
                background-color: #f6c90e; /* ë…¸ë‘ìƒ‰ ìƒë‹¨ ê°•ì¡°ì„  */
                margin-bottom: 10px;
            }
            /* ì¶”ê°€ì ì¸ ë””ìì¸ ìš”ì†Œ */
            .icon {
                width: 24px;
                height: 24px;
                vertical-align: middle;
                margin-right: 10px;
                fill: #9fcb3d; /* ì´ˆë¡ìƒ‰ ì•„ì´ì½˜ */
            }
            /* ê¸°ë³¸ ìŠ¤ìœ„ì¹˜ ë””ìì¸ ìˆ¨ê¸°ê¸° */
            .custom-switch {
                appearance: none;
                -webkit-appearance: none;
                width: 50px;
                height: 28px;
                background-color: #ccc;
                border-radius: 34px;
                position: relative;
                outline: none;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }
            /* ìŠ¤ìœ„ì¹˜ í•¸ë“¤ ë””ìì¸ */
            .custom-switch::before {
                content: "";
                position: absolute;
                width: 22px;
                height: 22px;
                background-color: white;
                border-radius: 50%;
                top: 3px;
                left: 3px;
                transition: transform 0.3s ease;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }

            /* ìŠ¤ìœ„ì¹˜ê°€ ì¼œì¡Œì„ ë•Œ ìƒ‰ìƒ ë³€ê²½ */
            .custom-switch:checked {
                background-color: #9fcb3d;
            }

            /* ìŠ¤ìœ„ì¹˜ê°€ ì¼œì¡Œì„ ë•Œ í•¸ë“¤ ìœ„ì¹˜ ë³€ê²½ */
            .custom-switch:checked::before {
                transform: translateX(22px);
            }

            #takingDetailLayout {
                padding: 20px 60px 20px 60px;
            }
        </style>
        <!-- ë‹¬ë ¥ ê¸°ëŠ¥ì„ ìœ„í•œ ë§í¬ ë° ìŠ¤íƒ€ì¼ ì ìš© ë -->

        <!-- í™”ë©´ ì‹œì‘ -->
        <div id="takingDetailLayout" class="row">
            <div class="col-lg-12 col-xl-6 order-lg-3 order-xl-2">
                <div class="card mb-g">
                    <div class="card-header" id="takingNm">
                        <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" />
                        </svg>
                        TAKING.INP_DT ì²˜ë°©ì „ ë³µìš© ì¼ì •
                    </div>
                    <div class="card-content">
                        <div class="pillContainer">
                            <!-- ì—¬ê¸°ì— ì•½ ëª©ë¡ì´ë‚˜ ë³µìš© ê´€ë ¨ ì •ë³´ê°€ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ëª¨ë‹¬ ì‹œì‘ -->
            <div class="modal fade show" id="pills-insert-modal" tabindex="-1" style="display: none; padding-right: 17px;" aria-modal="true" role="dialog">
                <div class="modal-dialog modal-dialog-centered modal-md" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">
                                <span id="modalMediNm"></span>
                                <small class="m-0 text-muted">
                                    ë³µìš© ì¼ì • ë“±ë¡
                                </small>
                            </h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true"><i class="fal fa-times"></i></span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label pl-1" for="datepicker-modal-2">ë³µìš©ì¼ ì„ íƒí•˜ê¸°</label>
                                <div class="input-group">
                                    <input type="date" id="datepicker-modal-2" class="form-control" placeholder="Select a date">
                                </div>
                                <span class="help-block pl-1">í•´ë‹¹ ì•½ì„ ë“œì‹  ë‚ ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="modalDismissBtn" class="btn btn-secondary waves-effect waves-themed" data-dismiss="modal">ë‹«ê¸°</button>
                            <button type="button" id="saveTkDtBtn" class="btn btn-primary waves-effect waves-themed">ë“±ë¡í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ëª¨ë‹¬ ë -->

            <!-- ë‹¬ë ¥ ì‹œì‘-->
            <div class="col-lg-12 col-xl-6 order-lg-3 order-xl-2">
                <div class="card mb-g">
                    <div class="row row-grid no-gutters">
                        <div class="col-12">
                            <div class="p-3 ml-auto">
                                <div style="display: flex; align-items: center;">
                                    <span class="mb-0 fs-xl">
                                    ë³µìš© ë‹¬ë ¥ğŸ˜
                    ï¸               </span>
                                    <div class="form-check form-switch fs-xl" style="margin-left: auto;">
                                        <label class="form-check-label" for="alarmSwitch">ì•Œë¦¼ ì„¤ì •
                                            <input class="form-check-input custom-switch ml-2" type="checkbox" id="alarmSwitch">
                                            <input id="switchUserId" name="userId" hidden>
                                            <input id="switchGubun"  name="gubun" hidden>
                                            <input id="switchInpDt"  name="inpDt" hidden>
                                        </label>
                                    </div>
                                </div>
                                <div id='calendar'></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ë‹¬ë ¥ ë -->
            <!-- ë‹¬ë ¥ ëª¨ë‹¬ì°½ ì‹œì‘ -->
            <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="eventModalLabel">ë³µìš©ì•½ ëª©ë¡</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <ul id="eventList"></ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="modalDismissBtn2" class="btn btn-secondary waves-effect waves-themed" data-dismiss="modal">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ë‹¬ë ¥ ëª¨ë‹¬ì°½ ë -->
        </div>
        <!-- í™”ë©´ ë -->


        <!-- ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ -->
        <script>
            const csrfToken = $('meta[name="_csrf"]').attr('content');
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');

            /** document ready */
            document.addEventListener('DOMContentLoaded', function() {
                getInitialSetting();
            });

            /** ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™” */
            const paramUserId = `[[${paramUserId}]]`;
            const paramGubun = `[[${paramGubun}]]`;
            const paramInpDt = `[[${paramInpDt}]]`;
            let currentData = {}
            document.getElementById('switchUserId').value = paramUserId;
            document.getElementById('switchGubun').value = paramGubun;
            document.getElementById('switchInpDt').value = paramInpDt;

            /** addEventListener */
            //ì•„ì´ì½˜ ë°ì´í„° ì„¸íŒ…
            document.querySelectorAll('.icon-link').forEach(function(iconLink){
                iconLink.addEventListener('click', iconDataSetting);
            });
            //ë‚ ì§œë“±ë¡í•˜ê¸°
            document.getElementById('saveTkDtBtn').addEventListener('click', saveTkDtB);

            /** function */
            //ê¸°ë³¸ ì„¤ì •
            function getInitialSetting(){
                getTakingDetail(function(data){ //í™”ë©´ ê¸°ë³¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    setCalendarData(data);      //ë‹¬ë ¥ ê¸°ë³¸ ì„¸íŒ…
                    updateIcons(data);          //ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                });
            }
            //ë³µìš© ìƒì„¸ ë°ì´í„° ê²€ìƒ‰í•˜ê¸°
            function getTakingDetail(callback){
                const dataToSend = {
                    userId: paramUserId,
                    gubun: paramGubun,
                    inpDt: paramInpDt,
                };

                fetch('/taking/takingDetailData',{
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(dataToSend)
                })
                .then(response => response.json())
                .then(data => {
                    if(callback) callback(data);
                    document.getElementById('takingNm').textContent = data[0].takingNm + ' (' + data[0].inpDt + ')'
                    document.getElementById('alarmSwitch').checked = data[0].alarm;
                })
                .catch(error => {
                    console.error('Error: ', error);
                    alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });

            }
            //ì•„ì´ì½˜ ë°ì´í„° ì„¸íŒ…
            function iconDataSetting(){
                const icon = this;
                currentData = {
                    mediNm: icon.querySelector('.mediNm').value,
                    tkId: icon.querySelector('.tkId').value,
                    tkSub: icon.querySelector('.tkSub').value,
                    userId: icon.querySelector('.userId').value,
                    gubun: icon.querySelector('.gubun').value,
                    inpDt: icon.querySelector('.inpDt').value,
                };
                document.getElementById('modalMediNm').textContent = currentData.mediNm;
            }
            //ë‚ ì§œ ì‚­ì œí•˜ê¸°
            function deleteTkDt(data){
                if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return false;

                const dataToSend = {
                    ...data,
                    tkDt: null,
                    tk: 0
                };
                //ì—…ë°ì´íŠ¸
                fetch('/taking/saveTakingDetail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(dataToSend)
                })
                    .then(response => response.json())
                    .then(() => {
                        alert("ë³µìš©ì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        //ëª¨ë‹¬ ë‹«ê¸°
                        document.getElementById('modalDismissBtn2').click();
                        //í™”ë©´ ì—…ë°ì´íŠ¸
                        getInitialSetting();
                    })
                    .catch(error => {
                        console.error('Error: ', error);
                        alert(error);
                    });
            }
            //ë‚ ì§œ ë“±ë¡í•˜ê¸°
            function saveTkDtB(){
                //ë³µìš©ì¼ì €ì¥
                let tkDt = document.getElementById('datepicker-modal-2').value;

                //ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
                if( !validateDate(tkDt) ){
                    alert('ë‚ ì§œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.');
                    return false;
                }

                const dataToSend = {
                    ...currentData,
                    tkDt: tkDt,
                    tk: 1
                };

                //ì—…ë°ì´íŠ¸
                fetch('/taking/saveTakingDetail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(dataToSend)
                })
                .then(response => response.json())
                .then(() => {
                    alert("ë³µìš©ì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    //ëª¨ë‹¬ ë‹«ê¸°
                    document.getElementById('modalDismissBtn').click();
                    //í™”ë©´ ì—…ë°ì´íŠ¸
                    getInitialSetting();
                })
                .catch(error => {
                    console.error('Error: ', error);
                    alert(error);
                });
            }

            //ë‚ ì§œ ìœ íš¨ì„± ê²€ì¦
            function validateDate(yyyymmdd) {
                // ë‚ ì§œ í˜•ì‹ ì •ê·œì‹ (YYYY-MM-DD)
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;

                // tkDtê°€ nullì´ê±°ë‚˜ ì •ê·œì‹ íŒ¨í„´ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš° false ë°˜í™˜
                if (!yyyymmdd || !datePattern.test(yyyymmdd)) {
                    return false;
                }

                // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
                const dateParts = yyyymmdd.split('-');
                const year = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10);
                const day = parseInt(dateParts[2], 10);

                // ì›”ì´ 1-12 ì‚¬ì´ì¸ì§€, ì¼ì´ 1-31 ì‚¬ì´ì¸ì§€ í™•ì¸
                if (month < 1 || month > 12 || day < 1 || day > 31) {
                    return false;
                }

                // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸ (ì˜ˆ: 2024-02-30 ê°™ì€ ë‚ ì§œëŠ” ì—†ìŒ)
                const date = new Date(yyyymmdd);
                if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
                    return false;
                }

                return true;
            }
            //ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            function updateIcons(data){

                const pillContainer = document.getElementsByClassName('pillContainer');

                //í•˜ìœ„ìš”ì†Œ ì „ë¶€ ì‚­ì œ
                while (pillContainer[0].firstChild) {
                    pillContainer[0].removeChild(pillContainer[0].firstChild);
                }

                data.forEach(taking => {
                    // Create outer div
                    const outerDiv = document.createElement('div');
                    outerDiv.className = 'col-12';

                    // Create p-3 d-flex div
                    const flexDiv = document.createElement('div');
                    flexDiv.className = 'p-3 d-flex';

                    // Create and append text elements
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'fw-500 fs-md';
                    nameDiv.textContent = taking.mediNm;
                    flexDiv.appendChild(nameDiv);

                    const memoSpan = document.createElement('span');
                    memoSpan.className = 'pl-3';
                    const memoIcon = document.createElement('i');
                    memoIcon.textContent = taking.memo;
                    memoSpan.appendChild(memoIcon);
                    flexDiv.appendChild(memoSpan);

                    const doseSpan = document.createElement('span');
                    doseSpan.className = 'ml-auto';
                    const eatenDose = document.createElement('i');
                    eatenDose.textContent = taking.eatenDoseCnt;
                    const slash = document.createElement('span');
                    slash.textContent = '/';
                    const totalDose = document.createElement('i');
                    totalDose.textContent = taking.totalDoseCnt;
                    const info = document.createElement('span');
                    info.textContent = ' (ë¨¹ìŒ/ì´ëŸ‰)';
                    doseSpan.appendChild(eatenDose);
                    doseSpan.appendChild(slash);
                    doseSpan.appendChild(totalDose);
                    doseSpan.appendChild(info);
                    flexDiv.appendChild(doseSpan);

                    outerDiv.appendChild(flexDiv);

                    // Create p-3 div for icons
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'p-3';

                    taking.takingDetailDTOList.forEach(detail => {
                        if ( !detail.tk ) {
                            const link = document.createElement('a');
                            link.href = 'javascript:void(0);';
                            link.className = 'waves-effect icon-link';
                            link.style.color = 'grey';
                            link.dataset.toggle = 'modal';
                            link.dataset.target = '#pills-insert-modal';

                            const icon = document.createElement('i');
                            icon.className = 'pl-2 fa-3x fal fa-pills';
                            icon.addEventListener('click', iconDataSetting);

                            // Add input elements to the icon
                            const inputs = [
                                { className: 'mediNm', value: taking.mediNm },
                                { className: 'tkId', value: detail.tkId },
                                { className: 'tkSub', value: detail.tkSub },
                                { className: 'userId', value: detail.userId },
                                { className: 'gubun', value: detail.gubun },
                                { className: 'inpDt', value: detail.inpDt }
                            ];

                            inputs.forEach(input => {
                                const inputElement = document.createElement('input');
                                inputElement.className = input.className;
                                inputElement.defaultValue = input.value || '';
                                inputElement.hidden = true;
                                icon.appendChild(inputElement);
                            });

                            link.appendChild(icon);
                            iconDiv.appendChild(link);
                        }
                    });

                    outerDiv.appendChild(iconDiv);
                    pillContainer[0].appendChild(outerDiv);
                });
            }
            //ë‹¬ë ¥ ê¸°ë³¸ ì„¸íŒ…
            function setCalendarData(data){
                //data ë‹¬ë ¥í˜•ì‹ìœ¼ë¡œ í¬ë§¤íŒ…
                let calendarData = [];
                data.forEach(taking => {
                    taking.takingDetailDTOList.forEach(detail => {
                        let inputData = {
                            tkId:detail.tkId,
                            tkSub:detail.tkSub,
                            userId:detail.userId,
                            gubun:detail.gubun,
                            inpDt:detail.inpDt,
                            title: taking.mediNm,
                            start: detail.tkDt,
                        };
                        calendarData.push(inputData);
                    });
                });

                let calendarEl = document.getElementById('calendar');
                let calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    // plugins: [ 'dayGrid', 'interaction' ],
                    editable: true,
                    locale: 'ko', // í•œê¸€ ë¡œì¼€ì¼ ì„¤ì •
                    headerToolbar: {
                        left: 'prev today',
                        center: 'title',
                        right: 'next',
                    },
                    events: calendarData,
                    displayEventTime:false,
                    editable: false,
                    dayMaxEventRows: true,
                    eventClick: function(info) {
                        let tkDetailDTO = info.event._def.extendedProps;
                        let eventList = document.getElementById('eventList');
                        eventList.innerHTML = '';

                        let listItem = document.createElement('li');
                        listItem.textContent = info.event.title + ' (' + tkDetailDTO.inpDt + "ì¼ ë³µìš©)";

                        const aItem = document.createElement('a');
                        aItem.href = 'javascript:void(0);';
                        aItem.className = 'btn btn-danger btn-xs waves-effect waves-themed m-3 fal fa-times';
                        aItem.addEventListener('click', () => deleteTkDt(tkDetailDTO));

                        // ì•„ì´ì½˜ì„ ìƒì„±í•˜ì—¬ ë²„íŠ¼ì— ì¶”ê°€
                        // const icon = document.createElement('i');
                        // icon.className = '';

                        // aItem.appendChild(icon);
                        listItem.appendChild(aItem);
                        eventList.appendChild(listItem);

                        $('#eventModal').modal('show');
                        return false; // ê¸°ë³¸ ë™ì‘ ë°©ì§€
                    }
                });
                calendar.render();
                //ì•Œë¦¼ ì„¤ì •
                $("#alarmSwitch").change(function(){
                    const label = this.parentElement;
                    const hiddenInput = label.querySelectorAll('input');
                    let dataToSend = {};
                    hiddenInput.forEach(input => {
                        dataToSend[input.name] = input.value;
                    });
                    dataToSend['alarm'] = this.checked;

                    fetch('/alarm/saveAlarm', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify(dataToSend)
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data);
                        })
                        .catch(error => {
                            console.error('Error: ', error);
                            alert(error);
                        });
                });
            }
        </script>
        <!-- ìŠ¤í¬ë¦½íŠ¸ ë -->
    </div>

</html>
