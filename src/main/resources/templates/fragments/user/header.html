<header class="page-header" role="banner" th:fragment="header" xmlns:sec="http://www.w3.org/1999/xhtml">
    <!-- we need this logo when user switches to nav-function-top -->
    <div class="page-logo">
        <a href="/" class="page-logo-link press-scale-down d-flex align-items-center position-relative">
            <img src="/img/new_logo.svg" alt="SmartAdmin WebApp" aria-roledescription="logo">
            <span class="page-logo-text mr-1">조약돌</span>
            <span class="position-absolute text-white opacity-50 small pos-top pos-right mr-2 mt-n2"></span>
            <span>(우리가 무심코 버린) 조그마한 약도 돌아온다</span>
        </a>
    </div>
    <!-- DOC: nav menu layout change shortcut -->
    <div class="hidden-md-down dropdown-icon-menu position-relative">
        <a href="#" class="header-btn btn js-waves-off" data-action="toggle" data-class="nav-function-hidden" title="Hide Navigation">
            <i class="ni ni-menu"></i>
        </a>
        <ul>
            <li>
                <a href="#" class="btn js-waves-off" data-action="toggle" data-class="nav-function-minify" title="Minify Navigation">
                    <i class="ni ni-minify-nav"></i>
                </a>
            </li>
            <li>
                <a href="#" class="btn js-waves-off" data-action="toggle" data-class="nav-function-fixed" title="Lock Navigation">
                    <i class="ni ni-lock-nav"></i>
                </a>
            </li>
        </ul>
    </div>
    <!-- DOC: mobile button appears during mobile width -->
    <div class="hidden-lg-up">
        <a href="#" class="header-btn btn press-scale-down" data-action="toggle" data-class="mobile-nav-on">
            <i class="ni ni-menu"></i>
        </a>
    </div>
<!--    <div class="search">-->
<!--        <form class="app-forms hidden-xs-down" role="search" action="page_search.html" autocomplete="off">-->
<!--            <input type="text" id="search-field" placeholder="무엇이든 검색하세요" class="form-control" tabindex="1">-->
<!--            <a href="#" onclick="return false;" class="btn-danger btn-search-close js-waves-off d-none" data-action="toggle" data-class="mobile-search-on">-->
<!--                <i class="fal fa-times"></i>-->
<!--            </a>-->
<!--        </form>-->
<!--    </div>-->
    <div class="ml-auto d-flex">
        <!-- activate app search icon (mobile) -->
        <div class="hidden-sm-up">
            <a href="#" class="header-icon" data-action="toggle" data-class="mobile-search-on" data-focus="search-field" title="Search">
                <i class="fal fa-search"></i>
            </a>
        </div>
        <!-- join us -->
        <div th:unless="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails)}"
             class="hidden-md-down" data-toggle="tooltip" data-placement="bottom" data-original-title="회원가입" data-trigger="hover">
            <a href="/auth/joinPage" class="header-icon">
                <i class="fal fa-user-plus"></i>
            </a>
        </div>
        <!-- login page -->
        <div th:unless="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails)}"
             class="hidden-md-down" data-toggle="tooltip" data-placement="bottom" data-original-title="로그인" data-trigger="hover">
            <a href="/auth/loginPage" class="header-icon">
                <i class="fal fa-sign-in-alt"></i>
            </a>
        </div>
        <!-- logout page -->
        <div th:if="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails)}"
             class="hidden-md-down" data-toggle="tooltip" data-placement="bottom" data-original-title="로그아웃" data-trigger="hover">
            <!-- <a href="/auth/logout" class="header-icon"> -->
            <a href="/auth/logout" class="header-icon">
                <i class="fal fa-sign-out-alt"></i>
            </a>
        </div>
        <!-- system manage -->
        <div th:if="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails)}"
             class="hidden-md-down" data-toggle="tooltip" data-placement="bottom" data-original-title="시스템 관리" data-trigger="hover">
            <a href="/system/user/manage" class="header-icon">
                <i class="fal fa-cog"></i>
            </a>
        </div>
        <!-- app settings -->
        <div th:if="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails)}"
             class="hidden-md-down" data-toggle="tooltip" data-placement="bottom" data-original-title="레이아웃 관리" data-trigger="hover">
            <a href="#" class="header-icon" data-toggle="modal" data-target=".js-modal-settings">
                <i class="fal fa-square"></i>
            </a>
        </div>
        <!-- app darkmode -->
        <div class="hidden-md-down" id="mode-d" data-toggle="tooltip" data-placement="bottom" data-original-title="다크 모드로 변경" data-trigger="hover">
            <a href="#" class="header-icon" onClick="layouts.mode('dark');">
                <svg style="font-size:17px" data-fa-symbol="delete" class="fa-adjust fa-w-16 fa-fw" aria-hidden="true" data-prefix="fal" data-icon="adjust" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="" id="delete">
                    <path fill="currentColor" d="M256 40c119.945 0 216 97.337 216 216 0 119.945-97.337 216-216 216-119.945 0-216-97.337-216-216 0-119.945 97.337-216 216-216m0-32C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm-32 124.01v247.98c-53.855-13.8-96-63.001-96-123.99 0-60.99 42.145-110.19 96-123.99M256 96c-88.366 0-160 71.634-160 160s71.634 160 160 160V96z"></path>
                </svg>
            </a>
        </div>
        <div class="hidden-md-down" id="mode-l" data-toggle="tooltip" data-placement="bottom" data-original-title="라이트 모드로 변경" data-trigger="hover">
            <a href="#" class="header-icon" onClick="layouts.mode('light');">
                <svg style="font-size:17px" data-fa-symbol="light-mode" class="fa-circle fa-w-16 fa-fw" aria-hidden="true" data-prefix="fas" data-icon="circle" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="" id="delete">
                    <path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"></path>
                </svg>
            </a>
        </div>
        <div class="hidden-md-down" id="mode-n" data-toggle="tooltip" data-placement="bottom" data-original-title="사이드바 강조 모드로 변경" data-trigger="hover">
            <a href="#" class="header-icon" onClick="layouts.mode('default');">
                <svg style="font-size:17px" data-fa-symbol="normal-mode" class="fa-circle fa-w-16 fa-fw" aria-hidden="true" data-prefix="fal" data-icon="circle" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg="" id="delete">
                    <path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm216 248c0 118.7-96.1 216-216 216-118.7 0-216-96.1-216-216 0-118.7 96.1-216 216-216 118.7 0 216 96.1 216 216z"></path>
                </svg>
            </a>
        </div>
        <!-- My Apps -->
        <!-- <div data-toggle="tooltip" data-placement="bottom" data-original-title="My Apps - 개발예정" data-trigger="hover">
            <a href="#" class="header-icon" data-toggle="dropdown" title="My Apps">
                <i class="fal fa-cube"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-animated w-auto h-auto">
                <div class="dropdown-header bg-trans-gradient d-flex justify-content-center align-items-center rounded-top">
                    <h4 class="m-0 text-center color-white">
                        Quick Shortcut
                        <small class="mb-0 opacity-80">User Applications & Addons</small>
                    </h4>
                </div>
                <div class="custom-scroll h-100">
                    <ul class="app-list">
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-2 icon-stack-3x color-primary-600"></i>
                                    <i class="base-3 icon-stack-2x color-primary-700"></i>
                                    <i class="ni ni-settings icon-stack-1x text-white fs-lg"></i>
                                </span>
                                <span class="app-list-name">
                                    Services
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-2 icon-stack-3x color-primary-400"></i>
                                    <i class="base-10 text-white icon-stack-1x"></i>
                                    <i class="ni md-profile color-primary-800 icon-stack-2x"></i>
                                </span>
                                <span class="app-list-name">
                                    Account
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-9 icon-stack-3x color-success-400"></i>
                                    <i class="base-2 icon-stack-2x color-success-500"></i>
                                    <i class="ni ni-shield icon-stack-1x text-white"></i>
                                </span>
                                <span class="app-list-name">
                                    Security
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-18 icon-stack-3x color-info-700"></i>
                                    <span class="position-absolute pos-top pos-left pos-right color-white fs-md mt-2 fw-400">28</span>
                                </span>
                                <span class="app-list-name">
                                    Calendar
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-7 icon-stack-3x color-info-500"></i>
                                    <i class="base-7 icon-stack-2x color-info-700"></i>
                                    <i class="ni ni-graph icon-stack-1x text-white"></i>
                                </span>
                                <span class="app-list-name">
                                    Stats
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-4 icon-stack-3x color-danger-500"></i>
                                    <i class="base-4 icon-stack-1x color-danger-400"></i>
                                    <i class="ni ni-envelope icon-stack-1x text-white"></i>
                                </span>
                                <span class="app-list-name">
                                    Messages
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-4 icon-stack-3x color-fusion-400"></i>
                                    <i class="base-5 icon-stack-2x color-fusion-200"></i>
                                    <i class="base-5 icon-stack-1x color-fusion-100"></i>
                                    <i class="fal fa-keyboard icon-stack-1x color-info-50"></i>
                                </span>
                                <span class="app-list-name">
                                    Notes
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-16 icon-stack-3x color-fusion-500"></i>
                                    <i class="base-10 icon-stack-1x color-primary-50 opacity-30"></i>
                                    <i class="base-10 icon-stack-1x fs-xl color-primary-50 opacity-20"></i>
                                    <i class="fal fa-dot-circle icon-stack-1x text-white opacity-85"></i>
                                </span>
                                <span class="app-list-name">
                                    Photos
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-19 icon-stack-3x color-primary-400"></i>
                                    <i class="base-7 icon-stack-2x color-primary-300"></i>
                                    <i class="base-7 icon-stack-1x fs-xxl color-primary-200"></i>
                                    <i class="base-7 icon-stack-1x color-primary-500"></i>
                                    <i class="fal fa-globe icon-stack-1x text-white opacity-85"></i>
                                </span>
                                <span class="app-list-name">
                                    Maps
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="/chat/index" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-5 icon-stack-3x color-success-700 opacity-80"></i>
                                    <i class="base-12 icon-stack-2x color-success-700 opacity-30"></i>
                                    <i class="fal fa-comment-dots icon-stack-1x text-white"></i>
                                </span>
                                <span class="app-list-name">
                                    Chat
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-5 icon-stack-3x color-warning-600"></i>
                                    <i class="base-7 icon-stack-2x color-warning-800 opacity-50"></i>
                                    <i class="fal fa-phone icon-stack-1x text-white"></i>
                                </span>
                                <span class="app-list-name">
                                    Phone
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="app-list-item hover-white">
                                <span class="icon-stack">
                                    <i class="base-6 icon-stack-3x color-danger-600"></i>
                                    <i class="fal fa-chart-line icon-stack-1x text-white"></i>
                                </span>
                                <span class="app-list-name">
                                    Projects
                                </span>
                            </a>
                        </li>
                        <li class="w-100">
                            <a href="#" class="btn btn-default mt-4 mb-2 pr-5 pl-5"> Add more apps </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div> -->
        <!-- 채팅 -->
        <!-- <div data-toggle="tooltip" data-placement="bottom" data-original-title="채팅 - 개발예정" data-trigger="hover">
            <a href="/chat/index" class="header-icon">
                <i class="fal fa-comment-dots"></i>
                <span class="badge badge-icon">!</span>
            </a>
        </div> -->
        <!-- 알림 -->
        <div th:if="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails)}"
             data-toggle="tooltip" data-placement="bottom" data-original-title="알림" data-trigger="hover">
            <a href="#" class="header-icon" data-toggle="dropdown" title="You got 11 notifications">
                <i class="fal fa-bell"></i>
                <span class="badge badge-icon" id="alarmCnt">0</span>
            </a>
            <div class="dropdown-menu dropdown-menu-animated dropdown-xl">
                <div class="dropdown-header bg-trans-gradient d-flex justify-content-center align-items-center rounded-top mb-2">
                    <h4 class="m-0 text-center color-white" id="alarmContentHead">
                        새로운 알림
                        <small class="mb-0 opacity-80">복용 정보</small>
                    </h4>
                </div>
                <ul class="nav nav-tabs nav-tabs-clean" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link px-4 fs-md js-waves-on fw-500" data-toggle="tab" href="#tab-alarms" data-i18n="drpdwn.alarms" id="alarmsTab">Alarms</a>
                    </li>
                </ul>
                <div class="tab-content tab-notification">
                    <div class="tab-pane" id="tab-alarms" role="tabpanel">
                        <div class="custom-scroll h-100">
                            <ul class="notification" id="noti">
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="py-2 px-3 bg-faded d-block rounded-bottom text-right border-faded border-bottom-0 border-right-0 border-left-0">
                    <a href="#" class="fs-xs fw-500 ml-auto text-info">알람 설정된 복용 정보가 표출됩니다.</a>
                </div>
            </div>
        </div>
        <!-- app user menu -->
        <div th:if="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails)}">
            <a href="#" data-toggle="dropdown" class="header-icon d-flex align-items-center justify-content-center ml-2">
                <img src="/img/user-profile.png" class="profile-image rounded-circle" alt="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails) ? #authentication.getPrincipal().getOswUser().getUserKornNam() : ''}">
            </a>
            <div class="dropdown-menu dropdown-menu-animated dropdown-lg">
                <div class="dropdown-header bg-trans-gradient d-flex flex-row py-4 rounded-top">
                    <div class="d-flex flex-row align-items-center mt-1 mb-1 color-white">
                        <span class="mr-2">
                            <img src="/img/user-profile.png" class="rounded-circle profile-image" alt="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails) ? #authentication.getPrincipal().getOswUser().getUserKornNam() : ''}">
                        </span>
                        <div class="info-card-text">
                            <div th:text="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails) ? #authentication.getPrincipal().getOswUser().getUserKornNam() : ''}"></div>
                            <span class="text-truncate text-truncate-md opacity-80" th:text="${#authentication.getPrincipal() instanceof T(org.springframework.security.core.userdetails.UserDetails) ? #authentication.getPrincipal().getOswUser().getUserKornNam() : ''}"></span>
                        </div>
                    </div>
                </div>
                <div class="dropdown-divider m-0"></div>
                <a href="/mypage/home" class="dropdown-item">
                    <i class="fal fa-user-alt"></i>
                    <span data-i18n="drpdwn.reset_layout">마이페이지</span>
                </a>
                <!-- <a class="dropdown-item" href="/auth/logout">
                    <i class="fal fa-sign-out"></i>
                    <span sec:authorize="isAuthenticated()" data-i18n="drpdwn.page-logout">로그아웃</span>
                </a> -->
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function(){

            getAlarmApi();

            //csrf 선언 여부 확인
            if (typeof window.csrfToken === 'undefined') {
                window.csrfToken = $('meta[name="_csrf"]').attr('content');
            }
            if (typeof window.csrfHeader === 'undefined') {
                window.csrfHeader = $('meta[name="_csrf_header"]').attr('content');
            }
        });

        //알람내용 세팅하기
        function setAlarmStatus(datas){
            //포커스
            let alarmsTab = document.getElementById('alarmsTab');
            if(alarmsTab) alarmsTab.click();

            //헤더 세팅
            let alarmCnt = document.getElementById('alarmCnt');
            let alarmContentHead = document.getElementById('alarmContentHead');
            const smallElement = document.createElement('small');
            smallElement.className = 'mb-0 opacity-80';
            smallElement.textContent = '복용 정보';

            let notCheckAlarm = 0;
            datas.forEach(data => {
                let takingStartDt = data.takingStartDt.split(' ')[0];
                //복용 시작일이 오늘보다 늦은가? && 복용 상태가 완료되었는가?
                if( (takingStartDt<= data.today) && (data.takingState != '1') ){
                    setAlarmBody(data); //알람바디세팅
                    //오늘 체크 했나? 여부 파악
                    if( data.today != data.checkDt) {
                        notCheckAlarm++;
                    }
                }
            });
            alarmCnt.innerText = notCheckAlarm;
            alarmContentHead.innerText = '미확인 알림 ' + notCheckAlarm + '건';
            alarmContentHead.appendChild(smallElement);
            //헤더 세팅 종료
        }

        //알림 바디 세팅
        function setAlarmBody(data){
            let noti = document.getElementById('noti');

            // 1. <li> 요소 생성 및 클래스 추가
            const liElement = document.createElement('li');
            if( data.today != data.checkDt ){
                liElement.className = 'unread';
            }

            // 2. <div class="d-flex align-items-center show-child-on-hover"> 생성
            const divElement = document.createElement('div');
            divElement.className = 'd-flex align-items-center show-child-on-hover';

            // 3. <span class="d-flex flex-column flex-1"> 생성
            const spanFlex1 = document.createElement('span');
            spanFlex1.className = 'd-flex flex-column flex-1';

            // 4. <span class="name d-flex align-items-center"> 생성
            const spanName = document.createElement('span');
            spanName.className = 'name d-flex align-items-center fs-md';
            spanName.innerHTML = data.takingNm;

            // 5. <span class="badge badge-success fw-n ml-1"> 생성 및 추가
            const spanBadge = document.createElement('span');
            spanBadge.className = 'badge badge-success fw-n ml-1';
            if( data.today != data.checkDt ){
                spanBadge.textContent = 'new';
            }

            // 6. <span class="msg-a fs-sm"> 생성 및 텍스트 추가
            const spanMsg = document.createElement('span');
            spanMsg.className = 'msg-a fs-sm';
            let htmlStr = '';
            data.alarmDetailDTOList.forEach( detail => {
                htmlStr += '<span class="fs-b">';
                htmlStr += detail.mediNm;
                htmlStr += '</span><br/>';
            });
            spanMsg.innerHTML = htmlStr;

            // 7. <span class="fs-nano text-muted mt-1">5 mins ago</span> 생성
            const detailMove = document.createElement('a');
            detailMove.href = '/taking/takingDetail/' + data.userId + '/' + data.gubun + '/' + data.inpDt;
            detailMove.textContent = '상세 이동';
            detailMove.addEventListener('click', () => updateCheckDt(data));

            // 8. <div class="show-on-hover-parent position-absolute pos-right pos-bottom p-3"> 생성
            const divHover = document.createElement('div');
            divHover.className = 'show-on-hover-parent position-absolute pos-right pos-bottom p-3';

            // 9. 연결 작업
            spanName.appendChild(spanBadge);
            // spanMsg.appendChild(patchNotesLink);
            spanFlex1.appendChild(spanName);
            spanFlex1.appendChild(spanMsg);
            spanFlex1.appendChild(detailMove);

            divElement.appendChild(spanFlex1);
            divElement.appendChild(divHover);

            liElement.appendChild(divElement);

            // 13. 원하는 위치에 추가 (예: <ul>이나 <ol> 요소에 추가)
            noti.prepend(liElement); // 부모 요소 선택하여 추가
        }

        //체크 알람 업데이트
        function updateCheckDt(data){
            fetch('/alarm/updateCheckDt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken,
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                })
                .catch(error => {
                    console.error('Error: ', error);
                });
        }

        //알람 내용 불러오기
        function getAlarmApi(){
            fetch('/alarm/getAlarmApi', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.indexOf('application/json') !== -1) {
                    return response.json();
                } else {
                    return response.text();
                }
            })
            .then(data => {
                if (typeof data === 'string') {
                    console.error('미로그인상태');
                } else {
                    setAlarmStatus(data);
                }
            })
            .catch(error => {
                console.error('Error: ', error);
            });
        }
    </script>
</header>